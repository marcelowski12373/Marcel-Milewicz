<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>System Głosowania</title>
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #1f1f1f;
      padding: 20px;
      text-align: center;
      font-size: 24px;
      font-weight: bold;
    }

    .tabs {
      display: flex;
      justify-content: center;
      background-color: #2a2a2a;
    }

    .tab {
      padding: 15px 30px;
      cursor: pointer;
      background-color: #2a2a2a;
      border: none;
      outline: none;
      color: #ccc;
      font-weight: bold;
    }

    .tab.active {
      background-color: #444;
      color: #fff;
    }

    .content {
      display: none;
      padding: 20px;
    }

    .content.active {
      display: block;
    }

    .box {
      background-color: #1e1e1e;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    input, button, select {
      display: block;
      margin: 10px 0;
      padding: 10px;
      width: 100%;
      max-width: 400px;
      font-size: 16px;
    }

    .vote-btn {
      background-color: #007bff;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .vote-btn:hover {
      background-color: #0056b3;
    }

    .delete-btn {
      background-color: #dc3545;
    }

    .info {
      margin-top: 10px;
      color: #0f0;
    }

    .error {
      color: #f00;
    }

    .countdown {
      font-weight: bold;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header>System Głosowania</header>
  <div class="tabs">
    <button class="tab active" onclick="showTab('admin')">Administracja</button>
    <button class="tab" onclick="showTab('user')">Użytkownicy</button>
  </div>
    <div id="admin" class="content active">
    <div class="box">
      <h2>Logowanie administratora</h2>
      <input id="adminLogin" type="text" placeholder="Wpisz login" />
      <button onclick="adminLogin()" class="vote-btn">Zaloguj</button>
      <div id="adminPanel" style="display:none;">
        <h3>Utwórz głosowanie</h3>
        <input id="voteQuestion" placeholder="Pytanie głosowania" />
        <div id="optionsContainer">
          <input class="optionInput" placeholder="Opcja 1" />
        </div>
        <button onclick="addOption()" class="vote-btn">Dodaj opcję</button>
        <input id="endTime" type="datetime-local" />
        <button onclick="startVoting()" class="vote-btn">Rozpocznij głosowanie</button>
        <button onclick="deleteVoting()" class="delete-btn">Usuń głosowanie</button>
        <div class="info" id="adminInfo"></div>
      </div>
    </div>
  </div>

  <div id="user" class="content">
    <div class="box">
      <h2>Głosowanie</h2>
      <input id="userLogin" type="text" placeholder="Wpisz swój login" />
      <div id="voteSection" style="display:none;">
        <div id="voteQuestionText"></div>
        <div id="voteOptions"></div>
        <button onclick="submitVote()" class="vote-btn">Oddaj głos</button>
        <div class="info" id="userInfo"></div>
        <div class="countdown" id="voteTimer"></div>
      </div>
    </div>
  </div>

  <div id="results" class="box" style="display:none;">
    <h3>Wyniki głosowania</h3>
    <div id="resultsContent"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBMX4gMbmRYMYbXheJvMtP6PtcHdc0AOYc",
  authDomain: "glosowanie-marcel.firebaseapp.com",
  databaseURL: "https://glosowanie-marcel-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "glosowanie-marcel",
  storageBucket: "glosowanie-marcel.appspot.com",
  messagingSenderId: "890689183476",
  appId: "1:890689183476:web:b1b2df2897ae0fbc6c64c7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let isAdmin = false;

function showTab(tab) {
  document.querySelectorAll(".tab").forEach(el => el.classList.remove("active"));
  document.querySelectorAll(".content").forEach(el => el.classList.remove("active"));
  document.querySelector(`.tab[onclick="showTab('${tab}')"]`).classList.add("active");
  document.getElementById(tab).classList.add("active");
}

function adminLogin() {
  const login = document.getElementById("adminLogin").value.trim();
  if (login === "komenda2025") {
    isAdmin = true;
    document.getElementById("adminPanel").style.display = "block";
    document.getElementById("adminInfo").textContent = "Zalogowano jako administrator.";
  } else {
    alert("Nieprawidłowy login administratora.");
  }
}

function addOption() {
  const input = document.createElement("input");
  input.classList.add("optionInput");
  input.placeholder = `Opcja ${document.querySelectorAll(".optionInput").length + 1}`;
  document.getElementById("optionsContainer").appendChild(input);
}

function startVoting() {
  const question = document.getElementById("voteQuestion").value.trim();
  const options = Array.from(document.querySelectorAll(".optionInput"))
    .map(input => input.value.trim())
    .filter(opt => opt);
  const endTime = new Date(document.getElementById("endTime").value).getTime();

  if (!question || options.length < 2 || isNaN(endTime)) {
    alert("Uzupełnij wszystkie pola (min. 2 opcje, poprawny czas).");
    return;
  }

  const data = {
    question,
    options,
    endTime,
    results: options.reduce((acc, cur) => (acc[cur] = 0, acc), {}),
    voted: {}
  };

  set(ref(db, "voting"), data).then(() => {
    document.getElementById("adminInfo").textContent = "Głosowanie rozpoczęte.";
  });
}

function deleteVoting() {
  set(ref(db, "voting"), null).then(() => {
    document.getElementById("adminInfo").textContent = "Głosowanie usunięte.";
  });
}

function submitVote() {
  const login = document.getElementById("userLogin").value.trim().toLowerCase();
  const selected = document.querySelector('input[name="vote"]:checked');
  if (!login || !selected) {
    document.getElementById("userInfo").textContent = "Wpisz login i wybierz opcję.";
    return;
  }

  get(ref(db, "voting")).then(snapshot => {
    if (snapshot.exists()) {
      const data = snapshot.val();
      if (data.voted && data.voted[login]) {
        document.getElementById("userInfo").textContent = "Ten login już głosował.";
        return;
      }
      data.results[selected.value]++;
      if (!data.voted) data.voted = {};
      data.voted[login] = true;
      set(ref(db, "voting"), data).then(() => {
        document.getElementById("userInfo").textContent = "Głos zapisany.";
      });
    }
  });
}

function renderVoting(data) {
  const now = Date.now();
  const expired = now >= data.endTime;

  if (expired) {
    document.getElementById("voteSection").style.display = "none";
    document.getElementById("results").style.display = "block";
    const results = Object.entries(data.results)
      .map(([k, v]) => `<div>${k}: ${v} głosów</div>`)
      .join("");
    document.getElementById("resultsContent").innerHTML = results;
  } else {
    document.getElementById("voteSection").style.display = "block";
    document.getElementById("results").style.display = "none";
    document.getElementById("voteQuestionText").textContent = data.question;
    document.getElementById("voteOptions").innerHTML = data.options.map(opt =>
      `<label><input type="radio" name="vote" value="${opt}" /> ${opt}</label>`
    ).join("");

    const countdown = () => {
      const now = Date.now();
      const left = data.endTime - now;
      if (left <= 0) {
        renderVoting(data);
        return;
      }
      const h = Math.floor(left / 3600000).toString().padStart(2, '0');
      const m = Math.floor((left % 3600000) / 60000).toString().padStart(2, '0');
      const s = Math.floor((left % 60000) / 1000).toString().padStart(2, '0');
      document.getElementById("voteTimer").textContent = `Pozostały czas: ${h}:${m}:${s}`;
      setTimeout(countdown, 1000);
    };
    countdown();
  }
}

onValue(ref(db, "voting"), snapshot => {
  const data = snapshot.val();
  if (data) {
    renderVoting(data);
  } else {
    document.getElementById("voteSection").style.display = "none";
    document.getElementById("results").style.display = "none";
  }
});
</script>
</body>
</html>
